# Excel AI チャットアシスタント

Excelを開いたまま、ChatGPTと会話する感覚でデータ分析・レポート作成・グラフ生成ができるMicrosoft Excel用のAIアドインです。

## 🎯 コアコンセプト

非エンジニアのExcelユーザーが自然言語でExcelのセルデータを分析・操作できるアドイン。複雑な関数やVBAを書く必要がなく、日本語で指示するだけで高度なデータ処理が可能です。

## ✨ 主な機能

### データ分析
- 「このデータを分析して」→ 合計、平均、最大値、最小値、中央値を自動計算
- 「異常値を見つけて」→ 外れ値の自動検出
- 「前月比を計算して」→ 増減率の自動計算

### データ操作
- 「空白セルを埋めて」→ 線形補間で自動補完
- 「重複を削除して」→ 重複行の自動削除
- 「並び替えて」→ 指定列でのソート

### レポート生成
- 「月次レポート作成」→ テンプレートに基づいてレポート自動生成
- 「サマリーシート作成」→ 新しいシートに集計結果を出力

### グラフ作成
- 「推移グラフ作って」→ 折れ線グラフ自動生成
- 「円グラフで表示」→ 構成比を可視化

## 🚀 クイックスタート

### 前提条件
- Node.js 18以上
- npm または pnpm
- OpenAI APIキー
- Microsoft Excel（デスクトップまたはOnline）

### インストール

```bash
# リポジトリをクローン
git clone <repository-url>
cd excel-ai-addon

# 依存関係をインストール
npm install

# 環境変数を設定
cp .env.example .env
# .envファイルを編集してOpenAI APIキーを設定
```

### 開発環境での実行

```bash
# サーバーとクライアントを同時に起動
npm start

# または別々に起動
npm run server      # ターミナル1
npm run client      # ターミナル2
```

サーバーは `http://localhost:3001` で起動し、クライアントは `http://localhost:3000` で起動します。

## 🔧 セットアップ詳細

詳細なセットアップ手順は [SETUP.md](./docs/SETUP.md) を参照してください。

### OpenAI APIキーの設定

1. [OpenAI公式サイト](https://platform.openai.com) でアカウントを作成
2. APIキーを生成
3. `.env` ファイルに以下を追加：

```
OPENAI_API_KEY=sk-...
```

### Excelでのサイドロード

1. Excel を開く
2. 「挿入」→「アドイン」→「マイアドイン」
3. 「マイアドインの管理」から `manifest.xml` をアップロード
4. アドインが表示されたら、クリックして起動

詳細は [SETUP.md](./docs/SETUP.md) を参照してください。

## 📖 使い方

### 基本的な流れ

1. **セルを選択**: Excelでデータを含むセル範囲を選択
2. **チャットに入力**: サイドパネルのチャット欄に自然言語で指示
3. **実行**: 「送信」ボタンをクリック
4. **結果確認**: 分析結果やレポートがセルに自動出力

### 使用例

#### 例1：売上データの分析
```
セル範囲: A1:C10（売上データ）
入力: 「このデータを分析して」
結果: 合計、平均、最大値などが自動計算されて表示
```

#### 例2：空白セルの補完
```
セル範囲: A1:B20（一部に空白がある）
入力: 「空白を埋めて」
結果: 線形補間で空白が自動補完される
```

#### 例3：月次レポート作成
```
セル範囲: A1:D30（月間データ）
入力: 「月次レポート作成」
結果: 新しいシートに集計結果が出力される
```

## 🏗️ プロジェクト構造

```
excel-ai-addon/
├── manifest.xml                 # Office Add-in定義
├── package.json                 # 依存関係
├── .env.example                 # 環境変数のサンプル
├── tsconfig.json               # TypeScript設定
│
├── src/
│   ├── taskpane/
│   │   ├── taskpane.html       # チャットUI（HTML）
│   │   ├── taskpane.tsx        # メインコンポーネント（React）
│   │   ├── taskpane.css        # スタイル
│   │   └── components/
│   │       ├── ChatMessage.tsx  # メッセージコンポーネント
│   │       ├── ChatInput.tsx    # 入力コンポーネント
│   │       └── LoadingSpinner.tsx # ローディング表示
│   │
│   └── server/
│       ├── server.js           # Express サーバー
│       ├── openai.js           # OpenAI API連携
│       └── excel-helpers.js    # Excel操作ヘルパー
│
├── docs/
│   ├── README.md               # このファイル
│   ├── SETUP.md                # 詳細セットアップ
│   └── DEPLOY.md               # デプロイ手順
│
└── public/
    └── index.html              # 静的ファイル
```

## 🔌 API仕様

### チャットエンドポイント

**POST** `/api/chat`

リクエスト：
```json
{
  "message": "ユーザーの指示",
  "cellData": {
    "address": "A1:C10",
    "values": [[...]]
  },
  "messageHistory": [...]
}
```

レスポンス：
```json
{
  "message": "AIの返答",
  "action": "write|analyze|report|chart|none",
  "data": {
    "address": "A1:B10",
    "values": [[...]]
  }
}
```

### 分析エンドポイント

**POST** `/api/analyze`

セルデータの統計情報と異常値を返します。

## ⚙️ 環境変数

| 変数 | 説明 | デフォルト |
|------|------|----------|
| `OPENAI_API_KEY` | OpenAI APIキー | 必須 |
| `PORT` | サーバーポート | 3001 |
| `NODE_ENV` | 実行環境 | development |
| `CORS_ORIGIN` | CORS許可元 | http://localhost:3000 |
| `OPENAI_MODEL` | 使用モデル | gpt-4 |
| `MAX_TOKENS` | 最大トークン数 | 2000 |

## 🧪 テストケース

以下のシナリオで動作確認できます：

### テスト1：基本的な分析
```
データ: A1:C10に売上データ（数値）
操作: 「合計を計算して」と入力
期待: 合計値がセルに出力される
```

### テスト2：空白補完
```
データ: A1:B20に一部空白のあるデータ
操作: 「空白を埋めて」と入力
期待: 線形補間で空白が埋められる
```

### テスト3：レポート生成
```
データ: A1:D30に月間データ
操作: 「月次レポート作成」と入力
期待: 新しいシートに集計結果が出力される
```

### テスト4：グラフ生成
```
データ: A1:B30に時系列データ
操作: 「推移グラフ作って」と入力
期待: 折れ線グラフが自動生成される
```

## 🐛 トラブルシューティング

### 問題：「設定が完了していません」エラーが表示される
**解決策：**
- `.env` ファイルに `OPENAI_API_KEY` が正しく設定されているか確認
- サーバーを再起動

### 問題：「データが選択されていません」エラーが表示される
**解決策：**
- Excelでセル範囲を選択してから、もう一度チャットに入力
- 複数セルを選択する場合は、A1:C10 のように範囲指定

### 問題：セルへの書き込みが反映されない
**解決策：**
- Excelが読み取り専用モードになっていないか確認
- ファイルを保存してから再度操作

### 問題：サーバーが起動しない
**解決策：**
```bash
# ポート3001が使用中でないか確認
lsof -i :3001

# 別のポートで起動
PORT=3002 npm run server
```

### 問題：OpenAI APIエラーが表示される
**解決策：**
- APIキーが正しいか確認
- APIの利用制限に達していないか確認
- インターネット接続を確認

## 📊 コスト管理

OpenAI APIの利用料金を抑えるための工夫：

1. **メッセージの要約**: 長いメッセージは自動で要約
2. **キャッシング**: 同じ分析は結果をキャッシュ
3. **トークン制限**: MAX_TOKENSで上限を設定（デフォルト2000）
4. **バッチ処理**: 複数の操作をまとめて実行

月額¥3万以内に収まる設計です。

## 🔒 セキュリティ

### APIキー管理
- APIキーは環境変数で管理（`.env` ファイルに保存）
- `.env` ファイルは `.gitignore` に追加済み
- 本番環境では環境変数を安全に設定

### CORS設定
- CORS_ORIGINで許可するオリジンを制限
- 本番環境では信頼できるドメインのみを許可

### データ保護
- セルデータはメモリ内でのみ処理
- ログにはセンシティブ情報を出力しない
- HTTPSを使用（本番環境）

## 📈 パフォーマンス

- **レスポンス時間**: 平均3-5秒（ネットワーク遅延を含む）
- **メモリ使用量**: 50-100MB
- **同時接続数**: 10+（スケーリング可能）

## 🚀 デプロイ

本番環境へのデプロイ方法は [DEPLOY.md](./docs/DEPLOY.md) を参照してください。

対応プラットフォーム：
- Azure App Service
- Heroku
- AWS Lambda
- Google Cloud Run

## 📝 ライセンス

MIT License

## 🤝 サポート

問題が発生した場合：

1. [トラブルシューティング](#トラブルシューティング) を確認
2. [SETUP.md](./docs/SETUP.md) で詳細手順を確認
3. コンソールのエラーメッセージを確認

## 📚 参考資料

- [Office JavaScript API リファレンス](https://docs.microsoft.com/en-us/office/dev/add-ins/reference/overview/)
- [OpenAI API ドキュメント](https://platform.openai.com/docs/)
- [Microsoft Excel アドイン開発](https://docs.microsoft.com/en-us/office/dev/add-ins/excel/)

## 🎓 学習リソース

このプロジェクトから学べること：

- Office.js を使用したExcel自動化
- React での UI開発
- Express でのバックエンド構築
- OpenAI API の統合
- TypeScript での型安全な開発

---

**バージョン**: 1.0.0  
**最終更新**: 2025年10月21日

